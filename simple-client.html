<html>

<head>
    <title>Streaming Client</title>
    <script src="socket.io/socket.io.js"></script>
    <style>
        #frames {
            width: 320px;
            height: 240px;
        }
        .frame {
            position: absolute;
            border: 1px solid red;
            border-radius: 0.5rem;
            z-index: 1;
        }
    </style>
</head>

<body>
    <img id='frames'>
    <div id='fps'></div>
</body>
<script>
    var updateFPS = (function () {
        var fps = null,
            fpsRA = [0, 0, 0, 0, 0],
            fpsTotal = 0,
            fpsIndex = 0,
            fpsLast = Date.now();
        
        return function () {
            var now = Date.now();
            fpsTotal -= fpsRA[fpsIndex];
            fpsRA[fpsIndex] = (now - fpsLast) / fpsRA.length;
            fpsTotal += fpsRA[fpsIndex++];
            fpsIndex %= fpsRA.length;
            fpsLast = now;
            if (fps == null) {
                fps = document.getElementById('fps');
            }
            fps.textContent = (Math.round(10000 / fpsTotal) / 10) + 'f/s (' + 
                Math.round(fpsTotal) + 'ms/frame)';
        }
    })();
    
    document.addEventListener('DOMContentLoaded', function () {
        frames = document.getElementById('frames');
        var nodeServer = document.location.href.replace(/^(https?:\/\/[^\/]+).*$/, '$1'),
            socket = io.connect(nodeServer, {
                'path': '/facetrack/socket.io'
            });

        socket.on('frame', function (data) {
            var fr = new FileReader();
            fr.onload = function (e) {
                frames.src = e.target.result.replace(
                    /data:;/, 'data:image/png;');
            };
            fr.readAsDataURL(new Blob([(new Uint8Array(data.image)).buffer]));

            /* Remove any current faces fraom the scene */
            Array.prototype.forEach.call(document.querySelectorAll('.face'), function (face) {
                face.parentElement.removeChild(face);
            });

            /* Add a new face element for each received face */
            faces.forEach(function (face) {
                var div = document.createElement('div');
                div.classList.add('face');
                div.style.left = face.left + 'px';
                div.style.top = face.top + 'px';
                div.style.width = face.width + 'px';
                div.style.height = face.height + 'px';
                document.body.appendChild(div);
            });
            updateFPS();
        });
    });
</script>
